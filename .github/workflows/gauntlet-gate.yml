name: gauntlet-gate

on:
  push:
    paths:
      - 'packages/rust-core/**'
      - '.github/workflows/gauntlet-gate.yml'
  pull_request:
    paths:
      - 'packages/rust-core/**'
      - '.github/workflows/gauntlet-gate.yml'
  workflow_dispatch:
    inputs:
      baseline_tag:
        description: 'Baseline release tag (default: nnue-gate)'
        required: false
        default: 'nnue-gate'
      candidate_tag:
        description: 'Candidate release tag (default: nnue-gate)'
        required: false
        default: 'nnue-gate'
      games:
        description: 'Number of games to play (default: 200)'
        required: false
        default: '200'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -C linker=clang -C link-arg=-fuse-ld=mold
  GATE_BASELINE_TAG: ${{ github.event.inputs.baseline_tag || 'nnue-gate' }}
  GATE_BASELINE_ASSET: baseline.nnue
  GATE_CANDIDATE_TAG: ${{ github.event.inputs.candidate_tag || 'nnue-gate' }}
  GATE_CANDIDATE_ASSET: candidate.nnue
  GAUNTLET_GAMES: ${{ github.event.inputs.games || '200' }}
  GAUNTLET_TC: "0/1+0.1"
  GAUNTLET_SEED: "12345"
  GAUNTLET_PV_MS: "300"
  GH_TOKEN: ${{ github.token }}

jobs:
  gate:
    name: Gauntlet Gate
    runs-on: ubuntu-latest
    timeout-minutes: 120
    defaults:
      run:
        working-directory: packages/rust-core
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: Check GitHub CLI
        run: |
          set -Eeuo pipefail
          gh --version
          gh auth status || true

      # Cacheシステムツール
      - name: Cache system tools
        id: cache-apt
        uses: actions/cache@v4
        with:
          path: |
            /usr/bin/mold
            /usr/bin/clang*
            /usr/bin/jq
          key: ${{ runner.os }}-apt-tools-v1

      - name: Install mold/clang/jq
        if: steps.cache-apt.outputs.cache-hit != 'true'
        run: |
          set -Eeuo pipefail
          sudo apt-get update
          sudo apt-get install -y mold clang jq
          mold --version || true
          clang --version || true
          jq --version || true

      - uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true

      # ビルド済みバイナリをキャッシュ
      - name: Cache built tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            packages/rust-core/target/release/gauntlet
            packages/rust-core/target/release/validate_gauntlet_schema
          key: ${{ runner.os }}-tools-${{ hashFiles('packages/rust-core/Cargo.lock', 'packages/rust-core/crates/tools/**/*.rs', 'packages/rust-core/crates/engine-core/**/*.rs') }}-nnue-telemetry

      - name: Build tools (release, locked)
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          set -Eeuo pipefail
          cargo build -p tools --release --locked --features nnue_telemetry

      # NNUEファイルをキャッシュ（リリースから取得する負荷を軽減）
      - name: Cache NNUE weights
        id: cache-weights
        uses: actions/cache@v4
        with:
          path: |
            packages/rust-core/runs/nnue_local/*.nnue
          key: ${{ runner.os }}-nnue-${{ env.GATE_BASELINE_TAG }}-${{ env.GATE_CANDIDATE_TAG }}

      - name: Prepare weights directory
        run: mkdir -p runs/nnue_local

      - name: Fetch baseline weights
        if: steps.cache-weights.outputs.cache-hit != 'true'
        env:
          RELEASE_TAG: ${{ env.GATE_BASELINE_TAG }}
          ASSET_NAME: ${{ env.GATE_BASELINE_ASSET }}
        run: |
          set -Eeuo pipefail
          DEST="runs/nnue_local/baseline.nnue"
          rm -f "$DEST"
          if [ -z "${RELEASE_TAG}" ] || [ -z "${ASSET_NAME}" ]; then
            echo "::error::GATE_BASELINE_TAG / GATE_BASELINE_ASSET must be set"
            exit 1
          fi
          echo "Downloading baseline from ${RELEASE_TAG}/${ASSET_NAME}"
          gh release download "${RELEASE_TAG}" \
            -R "$GITHUB_REPOSITORY" \
            -p "${ASSET_NAME}" \
            -O runs/nnue_local/baseline.nnue
          if [ ! -s "$DEST" ]; then
            echo "::error::Baseline weights not found. Provide runs/nnue_local/baseline.nnue or set GATE_BASELINE_TAG/GATE_BASELINE_ASSET to a valid release asset."
            exit 1
          fi

      - name: Fetch candidate weights
        if: steps.cache-weights.outputs.cache-hit != 'true'
        env:
          RELEASE_TAG: ${{ env.GATE_CANDIDATE_TAG }}
          ASSET_NAME: ${{ env.GATE_CANDIDATE_ASSET }}
        run: |
          set -Eeuo pipefail
          DEST="runs/nnue_local/candidate.nnue"
          rm -f "$DEST"
          if [ -z "${RELEASE_TAG}" ] || [ -z "${ASSET_NAME}" ]; then
            echo "::error::GATE_CANDIDATE_TAG / GATE_CANDIDATE_ASSET must be set"
            exit 1
          fi
          echo "Downloading candidate from ${RELEASE_TAG}/${ASSET_NAME}"
          gh release download "${RELEASE_TAG}" \
            -R "$GITHUB_REPOSITORY" \
            -p "${ASSET_NAME}" \
            -O runs/nnue_local/candidate.nnue
          if [ ! -s "$DEST" ]; then
            echo "::error::Candidate weights not found. Provide runs/nnue_local/candidate.nnue or set GATE_CANDIDATE_TAG/GATE_CANDIDATE_ASSET to a valid release asset."
            exit 1
          fi

      - name: Ensure opening book
        run: |
          set -Eeuo pipefail
          if [ ! -f docs/reports/fixtures/opening/representative_100.epd ]; then
            echo "::error::Opening book docs/reports/fixtures/opening/representative_100.epd not found"
            exit 1
          fi

      - name: Run gauntlet gate
        env:
          RAYON_NUM_THREADS: "1"
          RUST_BACKTRACE: "1"
        run: |
          set -Eeuo pipefail
          mkdir -p runs/gauntlet_gate
          target/release/gauntlet \
            --base runs/nnue_local/baseline.nnue \
            --cand runs/nnue_local/candidate.nnue \
            --time "${GAUNTLET_TC}" \
            --games "${GAUNTLET_GAMES}" \
            --threads 1 \
            --hash-mb 256 \
            --book docs/reports/fixtures/opening/representative_100.epd \
            --json runs/gauntlet_gate/out.json \
            --report runs/gauntlet_gate/report.md \
            --seed "${GAUNTLET_SEED}" \
            --pv-ms "${GAUNTLET_PV_MS}" \
            > runs/gauntlet_gate/structured.jsonl \
            2> runs/gauntlet_gate/console.err

      - name: Check gate decision
        run: |
          set -Eeuo pipefail
          if [ ! -f runs/gauntlet_gate/out.json ]; then
            echo "::error::out.json not found"
            exit 1
          fi
          GATE=$(jq -r '.summary.gate' runs/gauntlet_gate/out.json)
          NPS=$(jq -r '.summary.nps_samples // 0' runs/gauntlet_gate/out.json)
          PV=$(jq -r '.summary.pv_spread_samples // 0' runs/gauntlet_gate/out.json)
          echo "Gate=${GATE}, NPS_samples=${NPS}, PV_samples=${PV}"
          if [ "${GATE}" != "pass" ]; then
            echo "::error::Gauntlet gate failed (gate=${GATE})"
            exit 1
          fi
          if [ "${NPS}" -lt 50 ] || [ "${PV}" -lt 30 ]; then
            echo "::error::Insufficient samples (NPS=${NPS}, PV=${PV})"
            exit 1
          fi

      - name: Validate gauntlet out.json against schema
        run: |
          set -Eeuo pipefail
          target/release/validate_gauntlet_schema \
            --schema docs/schemas/gauntlet_out.schema.json \
            --input runs/gauntlet_gate/out.json

      - name: Copy report into docs tree
        if: always()
        run: |
          set -Eeuo pipefail
          DEST_DIR="docs/reports/gauntlet/ci/${GITHUB_RUN_ID}"
          mkdir -p "$DEST_DIR"
          if [ -f runs/gauntlet_gate/out.json ]; then
            cp runs/gauntlet_gate/out.json "$DEST_DIR/out.json"
          fi
          if [ -f runs/gauntlet_gate/report.md ]; then
            cp runs/gauntlet_gate/report.md "$DEST_DIR/report.md"
          fi
          if [ -f runs/gauntlet_gate/structured.jsonl ]; then
            cp runs/gauntlet_gate/structured.jsonl "$DEST_DIR/structured.jsonl"
          fi

      - name: Append gate summary
        if: always()
        run: |
          set -Eeuo pipefail
          echo "## Gauntlet Gate" >> "$GITHUB_STEP_SUMMARY"
          if [ -f runs/gauntlet_gate/out.json ]; then
            jq '.summary' runs/gauntlet_gate/out.json >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No out.json produced" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gauntlet-gate-${{ github.sha }}-${{ github.run_id }}
          path: |
            packages/rust-core/runs/gauntlet_gate/
            packages/rust-core/docs/reports/gauntlet/ci/${{ github.run_id }}
          retention-days: 14

      - name: sccache stats
        if: always()
        run: sccache --show-stats || true
