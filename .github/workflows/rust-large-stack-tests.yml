name: Rust Large Stack Tests

on:
  push:
    paths:
      - 'packages/rust-core/**'
      - '.github/workflows/rust-large-stack-tests.yml'
  pull_request:
    paths:
      - 'packages/rust-core/**'
      - '.github/workflows/rust-large-stack-tests.yml'
  workflow_dispatch:
    inputs:
      stack_size:
        description: 'Stack size in bytes (default: 8388608 = 8MB)'
        required: false
        default: '8388608'

env:
  CARGO_TERM_COLOR: always
  DEFAULT_STACK_SIZE: 8388608

defaults:
  run:
    working-directory: packages/rust-core

jobs:
  test-nnue-engines:
    name: NNUE & Enhanced Engine Tests
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]
        include:
          - os: ubuntu-latest
            rust: nightly
            experimental: true
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: dtolnay/rust-toolchain@${{ matrix.rust }}
      
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/rust-core
      
      - name: Set stack size
        id: stack
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "size=${{ github.event.inputs.stack_size }}" >> $GITHUB_OUTPUT
          else
            echo "size=${{ env.DEFAULT_STACK_SIZE }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Run ignored tests (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Running large stack tests on ${{ matrix.os }} with Rust ${{ matrix.rust }}"
          echo "Stack size: ${{ steps.stack.outputs.size }} bytes"
          echo ""
          echo "Test categories:"
          echo "1. Engine initialization tests"
          echo "2. NNUE evaluation tests"
          echo "3. Engine type switching tests"
          echo "4. Integration tests"
          echo ""
          RUST_MIN_STACK=${{ steps.stack.outputs.size }} cargo test -- --ignored --nocapture
      
      - name: Run ignored tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Running large stack tests on ${{ matrix.os }} with Rust ${{ matrix.rust }}"
          Write-Host "Stack size: ${{ steps.stack.outputs.size }} bytes"
          Write-Host ""
          $env:RUST_MIN_STACK = "${{ steps.stack.outputs.size }}"
          cargo test -- --ignored --nocapture
      
      - name: Test Summary
        if: always()
        run: |
          echo "## Test Summary for ${{ matrix.os }} - Rust ${{ matrix.rust }}"
          echo ""
          echo "### Ignored tests that were run:"
          grep -r "#\[ignore\]" --include="*.rs" . | grep -A1 "#\[ignore\]" | grep "fn test_" | sed 's/.*fn /- /' | sed 's/(.*$//' | sort | uniq || true

  benchmark-stack-requirements:
    name: Benchmark Stack Requirements
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/rust-core
      
      - name: Test different stack sizes
        run: |
          echo "Testing minimum stack size requirements..."
          echo ""
          
          for size in 1048576 2097152 4194304 8388608 16777216; do
            echo "Testing with stack size: $((size / 1048576))MB ($size bytes)"
            if RUST_MIN_STACK=$size timeout 60s cargo test -- --ignored > /dev/null 2>&1; then
              echo "✓ Success with $((size / 1048576))MB"
            else
              echo "✗ Failed with $((size / 1048576))MB"
            fi
            echo ""
          done

  release-mode-comparison:
    name: Debug vs Release Mode
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/rust-core
      
      - name: Compare debug and release modes
        run: |
          echo "## Comparing Debug vs Release mode stack requirements"
          echo ""
          
          echo "### Release mode (typically requires less stack):"
          if timeout 60s cargo test --release -- --ignored; then
            echo "✓ Release mode tests passed"
          else
            echo "✗ Release mode tests failed"
          fi
          
          echo ""
          echo "### Debug mode with large stack:"
          if RUST_MIN_STACK=8388608 timeout 60s cargo test -- --ignored; then
            echo "✓ Debug mode with 8MB stack passed"
          else
            echo "✗ Debug mode with 8MB stack failed"
          fi