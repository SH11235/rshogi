name: Rust Large Stack Tests

on:
  push:
    paths:
      - 'packages/rust-core/crates/engine-core/**'
      - 'packages/rust-core/crates/engine-usi/**'
      - 'packages/rust-core/Cargo.*'
      - '.github/workflows/rust-large-stack-tests.yml'
  pull_request:
    paths:
      - 'packages/rust-core/crates/engine-core/**'
      - 'packages/rust-core/crates/engine-usi/**'
      - 'packages/rust-core/Cargo.*'
      - '.github/workflows/rust-large-stack-tests.yml'
  workflow_dispatch:
    inputs:
      stack_size:
        description: 'Stack size in bytes (default: 8388608 = 8MB)'
        required: false
        default: '8388608'

env:
  CARGO_TERM_COLOR: always
  DEFAULT_STACK_SIZE: 8388608
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    working-directory: packages/rust-core

jobs:
  build-only-check:
    name: Build Check (large-stack-tests feature)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: "v0.10.0"
      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          key: ubuntu-latest-rust-stable-large-stack-build-only
          cache-on-failure: true

      - name: Build with large-stack-tests feature
        run: |
          echo "Building with large-stack-tests feature (--no-run)"
          echo "Target files: thread_pool.rs, driver.rs, Cargo.toml"
          cargo test -p engine-core --features large-stack-tests --no-run

      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  test-nnue-engines:
    name: NNUE & Enhanced Engine Tests
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    timeout-minutes: 30  # Increase timeout for large tests
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]
        include:
          - os: ubuntu-latest
            rust: nightly
            experimental: true

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: "v0.10.0"
      # macOSではsccacheを無効化
      # sccache経由だとコンパイルエラーの詳細が表示されず、デバッグが困難なため
      - name: Enable sccache (non-macOS only)
        if: runner.os != 'macOS'
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          key: ${{ matrix.os }}-rust-${{ matrix.rust }}-large-stack
          cache-on-failure: true

      - name: Set stack size
        id: stack
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Ensure numeric value with fallback
            SIZE=${{ github.event.inputs.stack_size || env.DEFAULT_STACK_SIZE }}
            echo "size=$SIZE" >> $GITHUB_OUTPUT
          else
            echo "size=${{ env.DEFAULT_STACK_SIZE }}" >> $GITHUB_OUTPUT
          fi

      - name: Run ignored tests (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Running large stack tests on ${{ matrix.os }} with Rust ${{ matrix.rust }}"
          echo "Stack size: ${{ steps.stack.outputs.size }} bytes"
          echo ""
          echo "Test categories:"
          echo "1. Engine initialization tests"
          echo "2. NNUE evaluation tests"
          echo "3. Engine type switching tests"
          echo "4. Integration tests"
          echo ""
          # Run ignored tests but exclude benchmark tests which can hang in CI
          # Use release build for performance-critical tests
          # Enable nightly features when using nightly Rust
          if [ "${{ matrix.rust }}" = "nightly" ]; then
            RUST_MIN_STACK=${{ steps.stack.outputs.size }} cargo test --release --features nightly -- --ignored --nocapture --skip test_benchmark
          else
            RUST_MIN_STACK=${{ steps.stack.outputs.size }} cargo test --release -- --ignored --nocapture --skip test_benchmark
          fi

      - name: Run ignored tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Running large stack tests on ${{ matrix.os }} with Rust ${{ matrix.rust }}"
          Write-Host "Stack size: ${{ steps.stack.outputs.size }} bytes"
          Write-Host ""
          $env:RUST_MIN_STACK = "${{ steps.stack.outputs.size }}"
          # Run ignored tests but exclude benchmark tests which can hang in CI
          # Use release build for performance-critical tests
          # Enable nightly features when using nightly Rust
          if ("${{ matrix.rust }}" -eq "nightly") {
            cargo test --release --features nightly -- --ignored --nocapture --skip test_benchmark
          } else {
            cargo test --release -- --ignored --nocapture --skip test_benchmark
          }

      - name: Test Summary
        if: always()
        shell: bash
        run: |
          echo "## Test Summary for ${{ matrix.os }} - Rust ${{ matrix.rust }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Stack size: ${{ steps.stack.outputs.size }} bytes" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- Rust: ${{ matrix.rust }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ignored tests that were run:" >> $GITHUB_STEP_SUMMARY
          cargo test -- --list --ignored 2>/dev/null | grep "test::" | sed 's/test::/- /' | sed 's/:.*$//' >> $GITHUB_STEP_SUMMARY || echo "Unable to list ignored tests" >> $GITHUB_STEP_SUMMARY
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  benchmark-stack-requirements:
    name: Benchmark Stack Requirements
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true

      - name: Test different stack sizes
        run: |
          echo "Testing minimum stack size requirements..."
          echo ""

          for size in 1048576 2097152 4194304 8388608 16777216; do
            echo "Testing with stack size: $((size / 1048576))MB ($size bytes)"
            if RUST_MIN_STACK=$size timeout 60s cargo test -- --ignored --skip test_benchmark > /dev/null 2>&1; then
              echo "✓ Success with $((size / 1048576))MB"
            else
              echo "✗ Failed with $((size / 1048576))MB"
            fi
            echo ""
          done
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  release-mode-comparison:
    name: Debug vs Release Mode
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true

      - name: Compare debug and release modes
        run: |
          echo "## Comparing Debug vs Release mode stack requirements"
          echo ""

          echo "### Release mode (typically requires less stack):"
          if timeout 60s cargo test --release -- --ignored --skip test_benchmark; then
            echo "✓ Release mode tests passed"
          else
            echo "✗ Release mode tests failed"
          fi

          echo ""
          echo "### Debug mode with large stack:"
          if RUST_MIN_STACK=8388608 timeout 60s cargo test -- --ignored --skip test_benchmark; then
            echo "✓ Debug mode with 8MB stack passed"
          else
            echo "✗ Debug mode with 8MB stack failed"
          fi
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true
