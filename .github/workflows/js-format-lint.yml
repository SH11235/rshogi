name: JS Format & Lint

on:
  push:
    branches: [main]
    paths:
      - "apps/**"
      - "packages/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "pnpm-workspace.yaml"
      - "turbo.json"
      - "biome.json"
      - "knip.json"
      - "tsconfig*.json"
      - "tsconfig.base.json"
      - ".github/workflows/js-format-lint.yml"
  pull_request:
    paths:
      - "apps/**"
      - "packages/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "pnpm-workspace.yaml"
      - "turbo.json"
      - "biome.json"
      - "knip.json"
      - "tsconfig*.json"
      - "tsconfig.base.json"
      - ".github/workflows/js-format-lint.yml"

env:
  CI: true
  PNPM_CACHE_DIR: ~/.pnpm-store
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"
  RUST_NIGHTLY_TOOLCHAIN: nightly-2025-12-25

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
      - id: versions
        run: |
          echo "node=$(node -p "require('./package.json').volta.node")" >> "$GITHUB_OUTPUT"
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.versions.outputs.node }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm format:ci

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
      - id: versions
        run: |
          echo "node=$(node -p "require('./package.json').volta.node")" >> "$GITHUB_OUTPUT"
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.versions.outputs.node }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  knip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
      - id: versions
        run: |
          echo "node=$(node -p "require('./package.json').volta.node")" >> "$GITHUB_OUTPUT"
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.versions.outputs.node }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm knip:ci

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
      - id: versions
        run: |
          echo "node=$(node -p "require('./package.json').volta.node")" >> "$GITHUB_OUTPUT"
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.versions.outputs.node }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      # engine-wasm は Wasm ビルド成果物 (pkg/) に依存するため、build ジョブで typecheck を実行
      - run: pnpm turbo typecheck --filter="!@shogi/engine-wasm"

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4
      - id: versions
        run: |
          echo "node=$(node -p "require('./package.json').volta.node")" >> "$GITHUB_OUTPUT"
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.versions.outputs.node }}
          cache: pnpm
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Setup Rust nightly (wasm threads)
        run: |
          rustup toolchain install "${RUST_NIGHTLY_TOOLCHAIN}"
          rustup component add rust-src --toolchain "${RUST_NIGHTLY_TOOLCHAIN}"
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      - name: Resolve wasm-bindgen version
        run: |
          CARGO_TOML_PATH="packages/rust-core/crates/engine-wasm/Cargo.toml"
          WASM_BINDGEN_VERSION=$(awk -F '"' '/^wasm-bindgen[[:space:]]*=/ {for(i=1;i<=NF;i++) if($i ~ /^[0-9]+\./){print $i; exit}}' "$CARGO_TOML_PATH")
          echo "WASM_BINDGEN_VERSION=$WASM_BINDGEN_VERSION" >> "$GITHUB_ENV"
          echo "Resolved wasm-bindgen version: $WASM_BINDGEN_VERSION"
      - name: Cache wasm-bindgen-cli
        id: cache-wasm-bindgen
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/wasm-bindgen
            ~/.cargo/bin/wasm-bindgen-test-runner
          key: wasm-bindgen-cli-${{ env.WASM_BINDGEN_VERSION }}-${{ runner.os }}
      - name: Install wasm-bindgen-cli
        if: steps.cache-wasm-bindgen.outputs.cache-hit != 'true'
        run: cargo install wasm-bindgen-cli --version "$WASM_BINDGEN_VERSION"
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      # engine-wasm は Wasm ビルド成果物 (pkg/) を参照するため、ビルド後に typecheck を実行
      - run: pnpm turbo typecheck --filter="@shogi/engine-wasm"
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true
