name: Rust CI

on:
  push:
    paths:
      - 'packages/rust-core/**'
      - 'apps/desktop/src-tauri/**'
      - '.github/workflows/rust-ci.yml'
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    working-directory: packages/rust-core

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust_code: ${{ steps.filter.outputs.rust_code }}
      tauri_code: ${{ steps.filter.outputs.tauri_code }}
    steps:
      - uses: actions/checkout@v5
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust_code:
              - 'packages/rust-core/Cargo.toml'
              - 'packages/rust-core/Cargo.lock'
              - 'packages/rust-core/build.rs'
              - 'packages/rust-core/crates/**'
              - 'packages/rust-core/.cargo/**'
              - '!packages/rust-core/docs/**'
              - '!packages/rust-core/runs/**'
              - '!packages/rust-core/logs/**'
              - '!packages/rust-core/target/**'
              - '!packages/rust-core/data/**'
              - '!packages/rust-core/memo/**'
              - '!**/*.md'
              - '!**/*.mdx'
            tauri_code:
              - 'apps/desktop/src-tauri/Cargo.toml'
              - 'apps/desktop/src-tauri/Cargo.lock'
              - 'apps/desktop/src-tauri/build.rs'
              - 'apps/desktop/src-tauri/src/**'
              - '!**/*.md'
              - '!**/*.mdx'

  format:
    name: Format Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  format-tauri:
    name: Format Check (tauri)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.tauri_code == 'true'
    defaults:
      run:
        working-directory: apps/desktop/src-tauri
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  lint:
    name: Clippy Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    steps:
      - uses: actions/checkout@v5
      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang
          mold --version || true
          clang --version || true
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true
      - name: Run Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  lint-tauri:
    name: Clippy Lint (tauri)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.tauri_code == 'true'
    defaults:
      run:
        working-directory: apps/desktop/src-tauri
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "apps/desktop/src-tauri -> target"
          cache-on-failure: true
      - name: Run Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v5
      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang
          mold --version || true
          clang --version || true
      - uses: dtolnay/rust-toolchain@stable
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true
      - name: Run tests
        run: cargo test --release --workspace -- --test-threads=2
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  test-tauri:
    name: Test (tauri)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.tauri_code == 'true'
    defaults:
      run:
        working-directory: apps/desktop/src-tauri
    steps:
      - uses: actions/checkout@v5
      - name: Install system deps (GTK/WebKit for Tauri)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            pkg-config \
            build-essential \
            curl \
            wget \
            file
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "apps/desktop/src-tauri -> target"
          cache-on-failure: true
      - name: Run tests
        run: cargo test --release --workspace -- --test-threads=2

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@cargo-audit
      - name: Run security audit
        run: cargo audit --deny warnings

  wasm32:
    name: Wasm (wasm32-unknown-unknown)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli --version 0.2.106
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true
      - name: Build wasm bindings
        run: node scripts/build-wasm.mjs
        working-directory: packages/engine-wasm
