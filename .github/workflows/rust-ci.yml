name: Rust CI

on:
  push:
    paths:
      - 'packages/rust-core/**'
      - '.github/workflows/rust-ci.yml'
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    working-directory: packages/rust-core

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust_code: ${{ steps.filter.outputs.rust_code }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust_code:
              - 'packages/rust-core/Cargo.toml'
              - 'packages/rust-core/Cargo.lock'
              - 'packages/rust-core/build.rs'
              - 'packages/rust-core/crates/**'
              - 'packages/rust-core/.cargo/**'
              - '!packages/rust-core/docs/**'
              - '!packages/rust-core/runs/**'
              - '!packages/rust-core/logs/**'
              - '!packages/rust-core/target/**'
              - '!packages/rust-core/data/**'
              - '!packages/rust-core/memo/**'
              - '!**/*.md'
              - '!**/*.mdx'

  format:
    name: Format Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  lint:
    name: Clippy Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang
          mold --version || true
          clang --version || true
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true
      - name: Run Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang
          mold --version || true
          clang --version || true
      - uses: dtolnay/rust-toolchain@stable
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Enable sccache
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "packages/rust-core -> target"
          cache-on-failure: true
      - name: Run tests
        run: cargo test --workspace -- --test-threads=2
      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_code == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@cargo-audit
      - name: Run security audit
        run: cargo audit --deny warnings
