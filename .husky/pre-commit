#!/usr/bin/env sh

echo "üìù Running lint-staged (format only)..."

# Windows Git Bash workaround for lint-staged
if [ "$OSTYPE" = "msys" ] || [ "$OSTYPE" = "cygwin" ] || [ -n "$MSYSTEM" ]; then
  powershell.exe -NoProfile -Command "pnpm exec lint-staged"
else
  pnpm exec lint-staged
fi

if git diff --cached --name-only -z --diff-filter=ACM | grep -qz '^packages/rust-core/.*\.rs$'; then
    echo "ü¶Ä Rust files in packages/rust-core detected, running cargo fmt..."
    (cd packages/rust-core && cargo fmt --all)
    git diff --cached --name-only -z --diff-filter=ACM | \
        grep -z '^packages/rust-core/.*\.rs$' | \
        xargs -0 -- git add --
fi

if git diff --cached --name-only -z --diff-filter=ACM | grep -qz '^apps/desktop/src-tauri/.*\.rs$'; then
    echo "ü¶Ä Rust files in apps/desktop/src-tauri detected, running cargo fmt..."
    (cd apps/desktop/src-tauri && cargo fmt --all)
    git diff --cached --name-only -z --diff-filter=ACM | \
        grep -z '^apps/desktop/src-tauri/.*\.rs$' | \
        xargs -0 -- git add --
fi
