# Rust Core Agent Guide

## 0. スコープと言語
- ここは npm/Turbo モノレポ `shogi` の Rust ワークスペース。上位リポジトリと密結合しているため、JavaScript パッケージの状態も常に意識してください。
- モノレポ全体（JS/Turbo/Volta）の詳細な運用ルールはリポジトリルートの `../../AGENTS.md` にまとめてあります。JS/フロント側の作業をする場合は必ずそちらを参照してください。
- Volta により Node 24.0.1 / npm 11.3.0 が固定されています。JS 側の作業前に `npm install` を一度だけ実行して依存を同期します。
- このコードベースでは日本語でやり取りすること。ドキュメントやコメントも可能な限り日本語（英語併記可）でまとめてください。

## Claude / Coding Expectations
### 早すぎる最適化は禁止
- 「必要になるまで書かない」が原則。測定無しの最適化、将来用のフィールド/フラグ追加、未使用コードの温存は禁止。
- 探索や NNUE のボトルネック議論では、実測データか再現手順をセットで提示してください。

### フォーマット文字列は最新構文を使う
```rust
// ❌ NG
println!("Note: {} positions had errors and were skipped", final_errors);
// ✅ OK
println!("Note: {final_errors} positions had errors and were skipped");
```
- すべての `format!`/`println!`/`eprintln!`/`write!` でインライン補間を用い、`uninlined_format_args` lint を満たすこと。

### 必須チェック
1. `cargo fmt && cargo clippy --fix --allow-dirty --tests`
2. `cargo test`
- Clippy の警告は `cargo clippy --fix --allow-dirty --tests` → 手動修正 → 再実行でゼロに。必要なら再度 `cargo fmt`。
- 警告抑止のために安易に `#[allow(...)]` や未使用変数へ `_` 接頭辞を付けることは禁止。

### 追加ベストプラクティス
- パニックより `Result` を優先し、公開 API には `///` ドキュメントを付与。
- 関数は単機能・短尺・説明的な変数名で。`iter` ベースの表現を優先。
- 仕様変更時はテストを先に追加し、`docs/` の対応するガイドを更新すること。

### コメント/ドキュメント方針（実験ラベルの禁止）
- コードコメントに一時ラベル（例: `S1`/`S2`/`試験A` などフェーズ名）を記載しないこと。
  - 理由: ラベルは文脈依存で将来の読者に伝わらないため。履歴はコミットログとレポートで追跡する。
- 代替方針:
  - コードには「恒久仕様の意図」と「将棋エンジン上の理由」を日本語で簡潔に記載（例: 手駒による連続王手の組合せ爆発を抑えるため 等）。
  - 背景・計測結果・判断は `docs/reports/<YYYYMMDD>-*.md` にまとめ、必要に応じてパス（ファイル名）をコメントに併記して参照可能にする。
  - 他実装を根拠にする場合は “YO 準拠” 等の恒久的な参照語とファイルパスで示し、短期の試行ラベルは使わない。

### 作業ログ（docs/reports, runs/）運用ルール
- 目的: 改修・計測・検証の過程を後から振り返れるよう、作業ごとに Markdown でログを残す。
- 出力場所:
  `docs/reports/`（無ければ作成）。
  `runs/`
- 形式: 作業ログはMarkdown（拡張子 `.md`）、runs以下でスクリプト由来の構造データを置く場合は任意（jsonなど）。
- ファイル名規約: 先頭にタイムスタンプを付ける。既定は `<YYYYMMDD>[-HHMM]-<tag>[-subtag].md`。
  - 生成物を時系列で自然ソートできるようにする。ls/エクスプローラでの閲覧性を担保。
- Git 取り扱い: 共有を目的としない“作業メモ”が主用途のため、原則コミット不要（任意）。
  - 共有したい内容に限り整形してコミット可。機微情報（鍵・トークン等）が含まれていないか要確認。
  - ローカルのみで差分を出したくない場合は `.git/info/exclude` に `docs/reports/*.md` を追加（個人環境の ignore）。
- 大きな生成物や付随データは `runs/`, `logs/`, `data/` へ配置し、レポートから相対パス参照する。
- 最低限の記載項目テンプレート:

```markdown
# タイトル（簡潔に）

- 日時: 2025-11-08 09:30 JST
- 作業種別: 改修 / 計測 / 再現 / ドキュメント など
- 目的: （何を確認/改善したいか）
- 変更/設定: （ブランチ/コミット、主要 setoption・環境変数・フラグ）
- 実行コマンド: （そのまま貼る。乱数seed/並列数/TCを明示）
- 入出力: （入力データ/ログ/生成物の相対パス）
- 結果サマリ: （数値・差分・グラフの説明。必要なら表や画像参照）
- 次アクション: （続きの実験やパッチ方針）
```
