# 置換表（Transposition Table）パフォーマンスサマリー

## 現在の実装状況

### アーキテクチャ
- **動的バケットサイジング**: Small(4)、Medium(8)、Large(16)エントリ構成を実装
- **SIMD最適化**: 並列キー検索のためのAVX2およびSSE2実装
- **自動サイズ選択**: テーブルサイズに基づく選択（≤8MB: Small、9-32MB: Medium、>32MB: Large）

## パフォーマンスベンチマーク

### バケットサイズ比較
| バケットサイズ | エントリ数 | メモリ | プローブ時間 | 用途 |
|------------|---------|--------|------------|----------|
| Small | 4 | 64B (1キャッシュライン) | 9.91 ns | キャッシュ効率重視（≤8MBテーブル） |
| Medium | 8 | 128B (2キャッシュライン) | 11.42 ns | バランス型（9-32MBテーブル） |
| Large | 16 | 256B (4キャッシュライン) | ~12-13 ns | 容量重視（>32MBテーブル） |

### SIMD vs スカラー性能（8エントリバケット）
| 操作 | スカラー | SIMD (SSE2修正前) | SIMD (SSE2修正後) | 優位 |
|-----------|--------|---------|---------|--------|
| ヒット（早期） | 4.77 ns | 6.23 ns | 6.23 ns | スカラー |
| ヒット（中間） | 5.26 ns | 6.20 ns | 6.21 ns | スカラー |
| ヒット（最後） | 5.71 ns | 6.20 ns | 7.01 ns | スカラー |
| ミス | 5.78 ns | 6.20 ns | 6.23 ns | スカラー |

**注**: SSE2のバグ修正により正確性は向上したが、パフォーマンスへの改善は見られない。むしろ最後のエントリのヒットで若干の性能低下が見られる。

### 主要な発見
1. **SIMDオーバーヘッド**: アトミックメモリ操作が性能を支配し、SIMDの利点を制限
2. **早期終了の優位性**: スカラーはマッチ時に早期終了可能、SIMDは全エントリを処理する必要がある
3. **キャッシュ効率**: 4エントリバケットは単一キャッシュラインに収まり、最良のレイテンシを提供
4. **SSE2実装の課題**: バグ修正後も性能向上せず、正確なマスク判定のオーバーヘッドが追加

## 技術詳細

### メモリレイアウト
- 各エントリ: 16バイト（8バイトキー + 8バイトデータ）
- アトミック操作: 読み込みに`Ordering::Acquire`、書き込みに`Ordering::Release`を使用
- アライメント: バケットはサイズ境界にアライン

### SIMD実装
- **4エントリ**: 単一AVX2 256ビットレジスタまたは2x SSE2 128ビットレジスタ
- **8エントリ**: 2x AVX2 256ビットレジスタ、前半マッチ時の早期終了付き
- **16エントリ**: 将来のAVX-512サポート準備済み

## 将来の最適化機会

1. **メモリバリア最適化**: relaxedオーダリング + フェンスでアトミック操作のオーバーヘッドを削減
2. **プリフェッチ戦略**: シーケンシャルアクセスパターンのキャッシュヒット率向上
3. **ハイブリッドアプローチ**: 最初の数エントリはスカラー、残りはSIMDで処理

## 結論

現在の実装は、置換表管理のための柔軟で拡張可能なアーキテクチャを提供している。メモリバウンドな操作のため、現在のベンチマークではSIMD最適化の利点は限定的だが、このインフラストラクチャは将来の最適化と、SIMDがより効果的になる可能性のある大規模バケットサイズをサポートしている。