# AI モジュール テストカバレッジ改善計画

## 概要

このドキュメントは、Shogi AI エンジンのテストカバレッジを改善するための計画を記載します。
現在のカバレッジ 61.72% (1298/2103行) を、段階的に 80% 以上に引き上げることを目標とします。

## 現状分析（2025年1月時点）

### モジュール別カバレッジ

| モジュール | 現在のカバレッジ | 目標カバレッジ | 優先度 |
|-----------|-----------------|---------------|--------|
| attacks.rs | 95.6% (195/204) | 95% | 完了 |
| benchmark.rs | 0% (0/33) | 30% | 低 |
| board.rs | 69.9% (181/259) | 85% | **最優先** |
| evaluate.rs | 100% (50/50) | 100% | 完了 |
| movegen.rs | 79.1% (461/583) | 90% | **最優先** |
| moves.rs | 77.0% (57/74) | 85% | **最優先** |
| search.rs | 85.2% (46/54) | 90% | 中 |
| zobrist.rs | 67.7% (63/93) | 80% | 中 |

## テスト追加計画

### 【最優先】ユーザー影響が大きい機能

これらの機能は、将棋エンジンの正確性に直接影響するため、最優先でテストを追加します。

#### 1. board.rs (目標: 69.9% → 85%)

##### Position::do_move() - 全ての着手タイプ
- [ ] 通常移動（各駒種: 歩、香、桂、銀、金、角、飛、王）
- [ ] 成り（歩→と、香→成香、桂→成桂、銀→成銀、角→馬、飛→龍）
- [ ] 駒を取る（相手の駒を捕獲）
- [ ] 持ち駒を打つ（歩、香、桂、銀、金、角、飛）
- [ ] 特殊ケース：打ち歩詰めの検証

##### Position::undo_move() - 手を戻す処理
- [ ] 通常移動の取り消し
- [ ] 成りの取り消し
- [ ] 駒取りの取り消し（捕獲した駒を元に戻す）
- [ ] 持ち駒打ちの取り消し
- [ ] 複数手の連続実行と戻し

##### Position::is_repetition() - 千日手判定
- [ ] 同一局面の2回繰り返し
- [ ] 同一局面の3回繰り返し（千日手）
- [ ] 持ち駒の違いによる非同一判定
- [ ] 手番の違いによる非同一判定

##### Board::king_square() - エッジケース
- [ ] 玉が盤上にない場合（詰み局面のテスト用）
- [ ] 両玉が盤上にある通常の場合

#### 2. movegen.rs (目標: 79.1% → 90%)

##### 王手回避手の生成
- [ ] 単一の王手からの回避（移動、合駒、王手駒の捕獲）
- [ ] 両王手の場合（玉の移動のみ）
- [ ] 飛び駒による王手への合駒
- [ ] 接近王手（玉の移動か捕獲のみ）

##### ピンされた駒の移動制限
- [ ] 絶対ピン（動くと自玉が取られる）
- [ ] 相対ピン（ピンの方向にのみ移動可能）
- [ ] ピンされた駒による王手駒の捕獲

##### 盤端での特殊な動き
- [ ] 桂馬：1段目、2段目（成り強制）、端筋（移動制限）
- [ ] 香車：1段目（成り強制）
- [ ] 歩：1段目（成り強制）、2段目（成り選択）

#### 3. moves.rs (目標: 77.0% → 85%)

##### 16ビットエンコーディング
- [ ] 全ての駒種の移動エンコーディング
- [ ] 全ての升目の組み合わせ（1一〜9九）
- [ ] 成りフラグのエンコーディング
- [ ] to_u16() → from_u16() のラウンドトリップテスト
- [ ] 不正な値のデコードエラー処理

##### MoveList
- [ ] 空のリストへの追加
- [ ] 最大容量（256手）までの追加
- [ ] イテレータの正確性
- [ ] clear() メソッドの動作

### 【中優先】内部品質向上

#### 4. zobrist.rs (目標: 67.7% → 80%)
- [ ] ハッシュ衝突テスト（1万局面以上）
- [ ] 持ち駒ハッシュの境界値（歩18枚など）
- [ ] 手番切り替えの一貫性
- [ ] 同一局面の同一ハッシュ値保証

#### 5. search.rs (目標: 85.2% → 90%)
- [ ] 時間制限による探索中断
- [ ] ノード数制限による探索中断
- [ ] should_stop() メソッドの各条件

### 【低優先】開発者向け機能

#### 6. benchmark.rs (目標: 0% → 30%)
- [ ] 関数が正しい型を返すかの確認
- [ ] パニックしないことの確認
- [ ] パフォーマンステストは #[ignore] で除外

## テスト実装のガイドライン

### 1. テストの命名規則
```rust
#[test]
fn test_<機能>_<シナリオ>() {
    // 例: test_do_move_pawn_promotion()
}
```

### 2. テストの構造
```rust
// Arrange: テスト環境の準備
let mut pos = Position::from_sfen("...");

// Act: テスト対象の実行
let result = pos.do_move(mv);

// Assert: 結果の検証
assert_eq!(result, expected);
```

### 3. 共通テストユーティリティ
```rust
#[cfg(test)]
mod test_utils {
    /// よく使うテスト局面を生成
    pub fn create_test_position(pattern: &str) -> Position {
        match pattern {
            "initial" => Position::startpos(),
            "endgame" => Position::from_sfen("..."),
            // 他のパターン
        }
    }
}
```

### 4. プロパティベーステスト（将来的な導入検討）
- 手生成の網羅性（生成された全ての手が合法）
- ハッシュ関数の均一性（偏りがない）
- do_move/undo_move の可逆性

## 成功指標

1. **短期目標（1ヶ月）**
   - 全体カバレッジ: 80% 以上
   - 最優先モジュール: 各目標カバレッジ達成

2. **中期目標（3ヶ月）**
   - 全体カバレッジ: 85% 以上
   - CI/CD でのカバレッジ自動監視

3. **品質指標**
   - 新規バグの発見と修正
   - パフォーマンスの維持（テスト追加による速度低下なし）
   - コードレビューでの指摘事項減少

## 実装スケジュール

1. **第1週**: board.rs のテスト追加
2. **第2週**: movegen.rs のテスト追加
3. **第3週**: moves.rs のテスト追加
4. **第4週**: カバレッジ測定と改善

## 関連ドキュメント

- [TDD Complete Guide](./tdd-complete-guide.md)
- [打ち歩詰め検出実装](../../../src/ai/movegen.rs)
- [GitHub Actions Coverage Workflow](../../../.github/workflows/coverage.yml)