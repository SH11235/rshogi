# Transposition Table (TT) 最適化サマリー

## 概要

Transposition Table（置換表）は将棋エンジンの探索性能を大幅に向上させる重要なコンポーネントです。本ドキュメントは、TTの実装と最適化に関する包括的な記録です。

## 目次
1. [現在の実装状況](#現在の実装状況)
2. [CAS最適化の記録](#cas最適化の記録)
3. [Prefetch最適化の分析](#prefetch最適化の分析)
4. [パフォーマンスベンチマーク](#パフォーマンスベンチマーク)
5. [技術的詳細](#技術的詳細)
6. [学んだ教訓](#学んだ教訓)
7. [今後の改善方針](#今後の改善方針)

---

## 現在の実装状況

### アーキテクチャ

- **動的バケットサイジング**: Small(4)、Medium(8)、Large(16)エントリ構成を実装
- **SIMD最適化**: 並列キー検索のためのAVX2およびSSE2実装
- **自動サイズ選択**: テーブルサイズに基づく選択
  - ≤8MB: Small (4エントリ)
  - 9-32MB: Medium (8エントリ)
  - >32MB: Large (16エントリ)
- **アトミック操作**: Compare-And-Swap (CAS) による安全な並列アクセス

### メモリレイアウト

- 各エントリ: 16バイト（8バイトキー + 8バイトデータ）
- アトミック操作: 読み込みに`Ordering::Acquire`、書き込みに`Ordering::Release`
- アライメント: バケットはサイズ境界にアライン

---

## CAS最適化の記録

### 背景（2025年8月）

Phase 4ベンチマークでTTのCAS（Compare-And-Swap）オーバーヘッドが26-82%の性能低下を引き起こしていることが判明。

### 実施内容と結果

#### Phase 1: 計測基盤とPrefetch無効化
- **結果**: +6.1%改善（予想を上回る）
- **発見**: CAS失敗率0%、70.7%が既存エントリ更新

#### Phase 2: Write-Through戦略
- **実装**: 既存エントリ更新でCAS回避
- **結果**: -2.3%性能低下（期待に反して）
- **原因**: 2回のReleaseストアがCAS1回より重い

#### Phase 2.1: Acquire/Release最適化
- **実装**: Acquireをdata側に移動、key再書き込み削除
- **結果**: -3.7%（さらに悪化）
- **発見**: 論理バグ - 空スロット挿入時にReaderが不整合を観測可能

#### Phase 1'（最終実装）
- **論理バグ修正**: data→key順序を保証
- **最適化**:
  - 既存エントリ: CAS不要、1ストア（70.7%）
  - 空スロット: 2ストア（29.3%）
- **結果**:
  - ストア数: 66.7%削減
  - CAS使用: 70.7%削減
  - 性能: -3.3%（正しさ優先）

### 論理バグの詳細

```rust
// 危険な実装（バグあり）
// 空スロット挿入時、keyとdataの書き込み順序が不適切
// Readerが不整合なデータを観測する可能性

// 修正後
// 1. dataを先に書き込み
// 2. Release barrierでメモリ順序を保証
// 3. keyを最後に書き込み
```

---

## Prefetch最適化の分析

### 実装フェーズ

#### Phase 2: Enhanced Implementation
軽量ハッシュ計算と選択的プリフェッチの実装

**成果**:
- **Depth 5**: +250% NPS改善（最大成功）
- **ノード削減**: 最大99.92%削減（depth 7）
- **軽量化**: ハッシュ計算を85%高速化（2-3ns）

#### Phase 3: Three-Way Comparison
NoTT vs TTOnly vs TT+Prefetchの比較

| Depth | TTOnly効果 | Prefetch追加効果 | 総改善率 |
|-------|------------|------------------|----------|
| 4 | -51.2% | +6.7% | -44.5% |
| 5 | -77.1% | +17.3% | -59.8% |
| 6 | -91.8% | +0.0% | -91.8% |

#### Phase 4: Four-Way Comparison（最新）
CAS操作とプリフェッチの影響を完全分離

**重要な発見**:
- **CASオーバーヘッド**: 単一スレッドでも26-66%の性能低下
- **プリフェッチ効果**: ほぼゼロまたは負の効果（-0.1%～-3.4%）
- **高ヒット率でも効果なし**: 93%ヒット率でも-0.3%の性能低下

### Prefetch効果の分析

| 深さ | ノード削減率 | CASオーバーヘッド | Prefetch効果 | ヒット率 |
|------|-------------|------------------|--------------|----------|
| 4 | 23-42% | -26～-40% | 0.0% | 15-43% |
| 5 | 37-69% | -37～-67% | -0.3% | 30-93% |
| 6 | 58-82% | -58～-82% | -0.5% | 27-52% |

**結論**: Prefetchの理論的利点がCASオーバーヘッドに完全に相殺される

---

## パフォーマンスベンチマーク

### バケットサイズ比較

| バケットサイズ | エントリ数 | メモリ | プローブ時間 | 用途 |
|---------------|-----------|--------|-------------|------|
| Small | 4 | 64B (1キャッシュライン) | 9.91 ns | キャッシュ効率重視 |
| Medium | 8 | 128B (2キャッシュライン) | 11.42 ns | バランス型 |
| Large | 16 | 256B (4キャッシュライン) | ~12-13 ns | 容量重視 |

### SIMD vs スカラー性能（8エントリバケット）

| 操作 | スカラー | SIMD | 優位 |
|------|---------|------|------|
| ヒット（早期） | 4.77 ns | 6.23 ns | スカラー |
| ヒット（中間） | 5.26 ns | 6.21 ns | スカラー |
| ヒット（最後） | 5.71 ns | 7.01 ns | スカラー |
| ミス | 5.78 ns | 6.23 ns | スカラー |

**注**: SIMDはアトミック操作のオーバーヘッドにより優位性を発揮できず

---

## 技術的詳細

### SIMD実装の詳細
- **4エントリ**: 単一AVX2 256ビットレジスタまたは2x SSE2 128ビットレジスタ
- **8エントリ**: 2x AVX2 256ビットレジスタ、前半マッチ時の早期終了付き
- **16エントリ**: 将来のAVX-512サポート準備済み

### アトミック操作の実装
```rust
// 現在の実装（シンプルだが確実）
pub fn probe(&self, key_hash: u64) -> Option<TTEntry> {
    let key = key_hash & KEY_MASK;
    let entry = self.entries[index].load(Ordering::Acquire);
    if entry.key() == key {
        Some(entry)
    } else {
        None
    }
}
```

---

## 学んだ教訓

### 1. 正しさが最優先
- 性能のためにデータ整合性を犠牲にしてはいけない
- 論理バグは微妙で発見が困難

### 2. 測定の重要性
- 理論と実装の乖離が明確になった（ストア削減≠性能向上）
- 複数の測定手法で多角的に評価する必要性

### 3. シンプルさの価値
- 複雑な最適化より、正しくシンプルな実装が重要
- CASは適切に使用すれば十分効率的

### 4. オーバーヘッドの理解
- アトミック操作のコストは想定以上に大きい
- SIMDの利点がメモリバリアで相殺される場合がある

---

## 今後の改善方針

### 短期（優先度：高）
1. **CASオーバーヘッド削減**
   - Read-Copy-Update (RCU) パターンの検討
   - Lock-freeアルゴリズムの改良

2. **メモリバリア最適化**
   - Relaxedオーダリング + 明示的フェンスの組み合わせ
   - プラットフォーム固有の最適化

### 中期（優先度：中）
1. **キャッシュライン最適化**
   - False sharing の削減
   - データ配置の最適化

2. **動的チューニング**
   - 実行時のアクセスパターンに基づく戦略切り替え
   - プロファイルガイド最適化

### 長期（優先度：低）
1. **次世代SIMD対応**
   - AVX-512サポート
   - ARM SVE対応

2. **代替データ構造**
   - Cuckoo hashingの検討
   - Robin Hood hashingの評価

---

## 関連ファイル

- `/crates/engine-core/src/search/tt.rs` - TT実装
- `/crates/engine-core/src/search/tt/` - バケット実装
- `/crates/tools/src/bin/tt_*_bench.rs` - 各種ベンチマークツール

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-08-09 | 3つのTTドキュメントを統合 |
| 2025-08-08 | CAS最適化Phase 1'完了 |
| 2025-08-07 | Prefetch Phase 4分析完了 |