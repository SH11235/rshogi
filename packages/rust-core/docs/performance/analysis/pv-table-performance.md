# PVテーブル実装のパフォーマンス分析

## 概要

このドキュメントは、Principal Variation (PV) テーブル実装のパフォーマンス分析結果をまとめたものです。2025年7月16日に実施したベンチマーク結果に基づいています。

## 実装の特徴

### PVテーブルの設計

- **データ構造**: 固定サイズ配列 `[[Move; MAX_PLY]; MAX_PLY]`
- **メモリ使用量**: 約64KB（MAX_PLY=127）
- **最適化**: `SmallVec<[Move; 128]>` によるヒープ割り当ての回避
- **安全性**: 合法性チェック、重複排除、境界チェック

### 探索への統合

- **手順優先順位**: TT move → PV move → 捕獲 → キラー → 静かな手
- **反復深化**: 前回の最善手順を保存・再利用
- **中断時の処理**: 探索が中断された場合はPVを無効化

## ベンチマーク環境

- **評価関数**: MaterialEvaluator（単純な駒得評価）
- **ビルドモード**: リリースビルド (`--release`)
- **測定日**: 2025年7月16日

## パフォーマンス測定結果

### 1. PVテーブル効果測定（pv_simple_bench）

**実行コマンド**: `cargo run --release --bin pv_simple_bench`

反復深化における各深さでの探索時間とPV（主要変化）の長さ：

| 深さ | 探索時間 (ms) | 最善手 | スコア | PV長 |
|------|--------------|--------|-------|------|
| 1 | 11 | 7g7f | -50 | 1 |
| 2 | 33 | 7g7f | 50 | 2 |
| 3 | 76 | 7g7f | -50 | 1 |
| 4 | 383 | 7g7f | 50 | 2 |
| 5 | 955 | 7g7f | -50 | 1 |
| 6 | 6,139 | 7g7f | 50 | 2 |
| 7 | 21,322 | 9c9d | -50 | 7 |

**総探索時間**: 28,919 ms（約29秒）

**最終的な主要変化（7手）**:
```
1. 9c9d
2. 1g1f
3. 5a4b
4. 2g2f
5. 8b9c
6. 5i6h
7. 1c1d
```

### 2. 総合探索ベンチマーク（shogi_benchmark）

**実行コマンド**: `cargo run --release --bin shogi_benchmark`

| 項目 | 性能値 |
|------|--------|
| 着手生成速度 | 1,783,817 moves/sec |
| 探索速度（NPS） | **5,302,243 nodes/sec** |
| 総探索ノード数 | 26,511,254 |
| 探索時間 | 5.000秒 |
| 最善手 | Move { data: 15794700 } |
| スコア | 50 |

### 3. SEE（静的交換評価）ベンチマーク（see_bench）

**実行コマンド**: `cargo bench --bench see_bench`

各種局面でのSEE計算時間：

| テストケース | 平均時間 | 性能変化 |
|-------------|---------|----------|
| 単純な捕獲 | 397.20 ns | -1.9% (改善) |
| 複雑な交換 | 397.02 ns | +2.5% (ノイズ範囲内) |
| X線攻撃 | 404.84 ns | 変化なし |
| 閾値評価(0) | 392.39 ns | +4.6% (若干の退行) |
| 閾値評価(100) | 348.32 ns | -0.4% (ノイズ範囲内) |
| 閾値評価(200) | 301.50 ns | +1.0% (ノイズ範囲内) |
| 閾値評価(-100) | 369.49 ns | -2.6% (ノイズ範囲内) |
| バッチ処理 | 2.45 µs | 変化なし |

## 性能分析

### PVテーブルのオーバーヘッド

Material評価関数での探索速度比較：

| 実装 | NPS | 備考 |
|------|-----|------|
| PVテーブルなし（以前の測定） | 5,343,723 | 基準値 |
| PVテーブルあり（今回の測定） | 5,302,243 | -0.8% |

**結論**: PVテーブルのオーバーヘッドは最小限（1%未満）

### メモリ効率

- **PVテーブルサイズ**: 約64KB
  - `Move`型: 4バイト
  - 配列: 127 × 127 × 4 = 64,516バイト
  - SmallVec: 追加で約512バイト
- **キャッシュ効率**: L2キャッシュ（通常256KB以上）に収まる

### PVテーブルの効果

1. **情報提供**
   - 深さ7で完全な7手のPVを保持
   - デバッグやGUI表示に有用

2. **探索の安定性**
   - 反復深化で前回の最善手順を再利用
   - より安定した探索結果

3. **将来的な最適化の基盤**
   - マルチPV対応への拡張が容易
   - 並列探索での活用可能

## 今後の課題

### 1. 探索効率の測定

現在の測定では「時間あたりのノード数」を見ているため、PVテーブルによる探索効率の向上が見えていません。以下の測定が必要です：

- 同じ深さまでの総探索ノード数の比較
- PVテーブルON/OFFでの分岐係数の違い
- 時間制限内で到達できる最大深さの比較

### 2. NNUE環境での測定

- NNUE評価関数使用時のパフォーマンス測定
- 評価関数の重さによるPVテーブル効果の違い

### 3. 並列探索での効果測定

- マルチスレッド環境でのPVテーブル共有コスト
- スレッドローカルPVテーブルの効果

## まとめ

PVテーブルの実装は成功し、以下の成果を達成しました：

1. **最小限のオーバーヘッド**: NPSの低下は1%未満
2. **効率的なメモリ使用**: 64KBの固定メモリでL2キャッシュ内に収まる
3. **有用な情報提供**: 完全なPVを保持し、デバッグ・表示に活用可能

今後は探索効率の定量的測定とNNUE環境での評価を行い、PVテーブルの真の効果を検証する必要があります。