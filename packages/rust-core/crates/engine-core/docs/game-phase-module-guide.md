# ゲームフェーズモジュール アーキテクチャガイド

## 概要

`game_phase`モジュールは、将棋のゲームフェーズ（序盤・中盤・終盤）を検出するための統一的で設定可能なシステムを提供します。以前の分散した実装を、Single Source of Truth（単一の信頼できる情報源）アプローチで置き換えました。

## 主要概念

### 1. 連続シグナル

ハードコーディングされた閾値の代わりに、連続シグナル（0.0〜1.0）を使用します：

- **駒得シグナル**: 0.0 = フル駒得、1.0 = 駒得なし
- **手数シグナル**: 0.0 = 序盤、1.0 = 終盤

### 2. 使用プロファイル

エンジンの異なる部分は、異なるフェーズ検出のニーズを持っています：

#### 探索プロファイル（Search Profile）
- **用途**: 並列探索でのスレッド割り当て
- **重み**: 駒得70%、手数30%
- **閾値**: 序盤→中盤は0.525、中盤→終盤は0.176
- **理由**: 計算の複雑さには駒得がより重要

#### 時間管理プロファイル（Time Profile）
- **用途**: 時間管理での時間配分
- **重み**: 駒得30%、手数70%
- **閾値**: 序盤→中盤は0.50、中盤→終盤は0.20
- **理由**: 時間配分にはゲーム進行（手数）がより重要

### 3. ヒステリシス

境界でのフェーズの振動を防ぐため、ヒステリシスを実装しています：
- フェーズ間の遷移時に、0.05のバッファが即座の反転を防ぎます
- これにより、小さな局面変化でも安定したフェーズ検出を保証します

## モジュール構造

```
game_phase/
├── mod.rs            # パブリックAPIとメイン検出関数
├── config.rs         # プロファイル設定とパラメータ
├── signals.rs        # 局面からのシグナル計算
├── classify.rs       # ヒステリシス付きフェーズ分類ロジック
└── tests.rs          # ユニットテストと統合テスト
```

## 統合ポイント

### エンジンコントローラー
```rust
// engine/game_phase_integration.rs内
pub fn detect_game_phase_for_search(pos: &Position, ply: u32) -> GamePhase
pub fn calculate_phase_score(pos: &Position, ply: u32) -> u8
```

### タイムマネージャー
```rust
// time_management/game_phase_integration.rs内
pub fn detect_game_phase_for_time(pos: &Position, ply: u32) -> GamePhase
pub fn estimate_moves_remaining_by_phase(phase: GamePhase, ply: u32) -> u32
```

## システムの特徴

- 設定可能なプロファイルによる統一検出
- 全コンポーネントが使用する単一実装
- 連続シグナルによりコード変更なしで微調整可能
- ヒステリシスが不安定性を防止
- スレッド割り当てロジック：序盤・中盤はフルスレッド、終盤は半分

## 設定

### 閾値の調整

フェーズ検出の動作を変更するには、`config.rs`を編集します：

```rust
PhaseParameters {
    w_material: 0.7,           // 駒得の重み
    w_ply: 0.3,                // 手数の重み
    opening_threshold: 0.525,   // 高いほど中盤への遷移が遅い
    endgame_threshold: 0.176,   // 低いほど終盤への遷移が早い
    hysteresis: 0.05,          // 安定性のためのバッファ
}
```

### 新しいプロファイルの追加

1. `Profile`列挙型に新しいバリアントを追加
2. `PhaseParameters::for_profile`に設定を追加
3. 適切なモジュールに統合関数を作成

## パフォーマンスに関する考慮事項

- すべての検出関数は最適化のため`#[inline]`でマーク
- シグナル計算は軽量（単純な算術演算）
- ヒステリシスチェックのオーバーヘッドは最小限
- アロケーションや複雑な計算なし

## テスト

モジュールには包括的なテストが含まれています：
- シグナル計算のユニットテスト
- ベースライン動作に一致する統合テスト
- ヒステリシス安定性テスト
- プロファイル固有の動作テスト

## 将来の改善案

潜在的な拡張（早すぎる最適化を避けるため未実装）：
- ゲームタイプに基づく動的閾値調整
- 閾値最適化のための機械学習
- 追加シグナル（玉の安全性、歩の構造）
- 時間制御に基づくプロファイル選択